---
title: "Bar Charts"
author: "Haley Jeppson"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
```

Set-up:

```{r}
# devtools::install_github("ijlyttle/altair")
library("altair")

vega_data <- import_vega_data()
```


#### Bar Chart with Highlight

```{r}

dat = data_frame(Day =1:15, 
                 Value = c(54.8, 112.1, 63.6, 37.6, 79.7, 137.9, 120.1, 103.3, 394.8,
                           199.5, 72.3, 51.1, 112.0, 174.5, 130.5))

data2 = data_frame(ThresholdValue = 300, Threshold = "hazardous")

bar1 <- 
  alt$Chart(
    r_to_py(dat)
  )$mark_bar(
  )$encode(
    x='Day:O',
    y='Value:Q'
)

bar2 <- 
  alt$Chart(
    r_to_py(dat)
  )$mark_bar(color="#e45755"
  )$encode(
    x='Day:O',
    y='baseline:Q',
    y2='Value:Q'
)$transform_filter(
    "datum.Value >= 300"
)$transform_calculate(
    "baseline", "300"
)

rule <- alt$Chart(
  r_to_py(data2)
  )$mark_rule(
  )$encode(
    y='ThresholdValue:Q'
)

text = alt$Chart(
  r_to_py(data2)
  )$mark_text(
    align='left', dx=215, dy=-5
)$encode(
    alt$Y('ThresholdValue:Q', axis=alt$Axis(title='PM2.5 Value')),
    text=alt$value('hazardous')
)

vegalite(bar1 + text + bar2 + rule)
```

#### Box Plot with Min/Max Whiskers


```{r}


# Define aggregate fields
lower_box = 'q1(people):Q'
lower_whisker = 'min(people):Q'
upper_box = 'q3(people):Q'
upper_whisker = 'max(people):Q'

# Compose each layer individually
lower_plot <- alt$Chart(
    r_to_py(vega_data$population())
  )$mark_rule()$encode(
    y=alt$Y(lower_whisker, axis=alt$Axis(title="population")),
    y2=lower_box,
    x='age:O'
)

middle_plot <- alt$Chart(
    r_to_py(vega_data$population())
  )$mark_bar(size=5.0)$encode(
    y=lower_box,
    y2=upper_box,
    x='age:O'
)

upper_plot <- alt$Chart(
    r_to_py(vega_data$population())
  )$mark_rule()$encode(
    y=upper_whisker,
    y2=upper_box,
    x='age:O'
)

middle_tick <- alt$Chart(
    r_to_py(vega_data$population())
  )$mark_tick(
    color='white',
    size=5.0
)$encode(
    y='median(people):Q',
    x='age:O'
)

vegalite(lower_plot + middle_plot + upper_plot + middle_tick)
```

#### Calculating Percentage of Total (not working)

Not sure how to handle the `transform_window` part

```{r, eval = FALSE}

activities <- data_frame(Activity = c('Sleeping', 'Eating', 'TV', 'Work', 'Exercise'),
                         Time = c(8, 2, 4, 8, 2))

plot <- alt$Chart(
  r_to_py(activities)
  )$mark_bar()$encode(
    alt$X('PercentOfTotal:Q', axis=alt$Axis(format='.0%')),
    y='Activity:N'
)$transform_window(
    window=list(alt$WindowFieldDef(op='sum', field='Time', "**{'as': 'TotalTime'}")),
    frame= list(NULL, NULL)
)$transform_calculate(
    PercentOfTotal="datum.Time / datum.TotalTime"
)

vegalite(plot)
```

#### Candlestick Chart

```{r, echo = FALSE}
df <- jsonlite::fromJSON('[
      {
        "date": "01-Jun-2009",
        "open": 28.7,
        "high": 30.05,
        "low": 28.45,
        "close": 30.04,
        "signal": "short",
        "ret": -4.89396411092985
      },
      {
        "date": "02-Jun-2009",
        "open": 30.04,
        "high": 30.13,
        "low": 28.3,
        "close": 29.63,
        "signal": "short",
        "ret": -0.322580645161295
      },
      {
        "date": "03-Jun-2009",
        "open": 29.62,
        "high": 31.79,
        "low": 29.62,
        "close": 31.02,
        "signal": "short",
        "ret": 3.68663594470045
      },
      {
        "date": "04-Jun-2009",
        "open": 31.02,
        "high": 31.02,
        "low": 29.92,
        "close": 30.18,
        "signal": "short",
        "ret": 4.51010886469673
      },
      {
        "date": "05-Jun-2009",
        "open": 29.39,
        "high": 30.81,
        "low": 28.85,
        "close": 29.62,
        "signal": "short",
        "ret": 6.08424336973478
      },
      {
        "date": "08-Jun-2009",
        "open": 30.84,
        "high": 31.82,
        "low": 26.41,
        "close": 29.77,
        "signal": "short",
        "ret": 1.2539184952978
      },
      {
        "date": "09-Jun-2009",
        "open": 29.77,
        "high": 29.77,
        "low": 27.79,
        "close": 28.27,
        "signal": "short",
        "ret": -5.02431118314424
      },
      {
        "date": "10-Jun-2009",
        "open": 26.9,
        "high": 29.74,
        "low": 26.9,
        "close": 28.46,
        "signal": "short",
        "ret": -5.46623794212217
      },
      {
        "date": "11-Jun-2009",
        "open": 27.36,
        "high": 28.11,
        "low": 26.81,
        "close": 28.11,
        "signal": "short",
        "ret": -8.3743842364532
      },
      {
        "date": "12-Jun-2009",
        "open": 28.08,
        "high": 28.5,
        "low": 27.73,
        "close": 28.15,
        "signal": "short",
        "ret": -5.52763819095477
      },
      {
        "date": "15-Jun-2009",
        "open": 29.7,
        "high": 31.09,
        "low": 29.64,
        "close": 30.81,
        "signal": "long",
        "ret": 3.4920634920635
      },
      {
        "date": "16-Jun-2009",
        "open": 30.81,
        "high": 32.75,
        "low": 30.07,
        "close": 32.68,
        "signal": "short",
        "ret": 0.155038759689914
      },
      {
        "date": "17-Jun-2009",
        "open": 31.19,
        "high": 32.77,
        "low": 30.64,
        "close": 31.54,
        "signal": "short",
        "ret": 5.82822085889571
      },
      {
        "date": "18-Jun-2009",
        "open": 31.54,
        "high": 31.54,
        "low": 29.6,
        "close": 30.03,
        "signal": "short",
        "ret": 8.17610062893082
      },
      {
        "date": "19-Jun-2009",
        "open": 29.16,
        "high": 29.32,
        "low": 27.56,
        "close": 27.99,
        "signal": "short",
        "ret": 8.59872611464968
      },
      {
        "date": "22-Jun-2009",
        "open": 30.4,
        "high": 32.05,
        "low": 30.3,
        "close": 31.17,
        "signal": "short",
        "ret": 15.4907975460123
      },
      {
        "date": "23-Jun-2009",
        "open": 31.3,
        "high": 31.54,
        "low": 27.83,
        "close": 30.58,
        "signal": "short",
        "ret": 11.7370892018779
      },
      {
        "date": "24-Jun-2009",
        "open": 30.58,
        "high": 30.58,
        "low": 28.79,
        "close": 29.05,
        "signal": "long",
        "ret": -10.4234527687296
      },
      {
        "date": "25-Jun-2009",
        "open": 29.45,
        "high": 29.56,
        "low": 26.3,
        "close": 26.36,
        "signal": "long",
        "ret": 0
      },
      {
        "date": "26-Jun-2009",
        "open": 27.09,
        "high": 27.22,
        "low": 25.76,
        "close": 25.93,
        "signal": "long",
        "ret": 0
      },
      {
        "date": "29-Jun-2009",
        "open": 25.93,
        "high": 27.18,
        "low": 25.29,
        "close": 25.35,
        "signal": "long",
        "ret": 5.26315789473684
      },
      {
        "date": "30-Jun-2009",
        "open": 25.36,
        "high": 27.38,
        "low": 25.02,
        "close": 26.35,
        "signal": "long",
        "ret": 6.73758865248228
      }
    ]'
)

```


Not sure how to specify the domain so I left it out

```{r}

open_close_color = alt$condition("datum.open < datum.close",
                                 alt$value("#06982d"),
                                 alt$value("#ae1325"))

rule = alt$Chart(
  r_to_py(df)
  )$mark_rule()$encode(
    alt$X(
        'date:T',
        timeUnit='yearmonthdate',
        #scale=alt$Scale(domain= list(c(month= 5, date= 31, year= 2009),
         #                       c(month= 7, date= 1, year= 2009))),
        axis=alt$Axis(format='%m/%d', title='Date in 2009')
    ),
    alt$Y(
        'low',
        scale=alt$Scale(zero=FALSE),
        axis=alt$Axis(title='Price')
    ),
    alt$Y2('high'),
    color=open_close_color
)

bar = alt$Chart(
  r_to_py(df)
  )$mark_bar()$encode(
    alt$X('date:T', timeUnit='yearmonthdate'),
    y='open',
    y2='close',
    color=open_close_color
)

vegalite(rule + bar)

```


#### Diverging Stacked Bar Chart

```{r, echo = FALSE}
data <- jsonlite::fromJSON('[
  {
        "question": "Question 1",
        "type": "Strongly disagree",
        "value": 24,
        "percentage": 0.7,
        "percentage_start": -19.1,
        "percentage_end": -18.4
      },
      {
        "question": "Question 1",
        "type": "Disagree",
        "value": 294,
        "percentage": 9.1,
        "percentage_start": -18.4,
        "percentage_end": -9.2
      },
      {
        "question": "Question 1",
        "type": "Neither agree nor disagree",
        "value": 594,
        "percentage": 18.5,
        "percentage_start": -9.2,
        "percentage_end": 9.2
      },
      {
        "question": "Question 1",
        "type": "Agree",
        "value": 1927,
        "percentage": 59.9,
        "percentage_start": 9.2,
        "percentage_end": 69.2
      },
      {
        "question": "Question 1",
        "type": "Strongly agree",
        "value": 376,
        "percentage": 11.7,
        "percentage_start": 69.2,
        "percentage_end": 80.9
      },

      {
        "question": "Question 2",
        "type": "Strongly disagree",
        "value": 2,
        "percentage": 18.2,
        "percentage_start": -36.4,
        "percentage_end": -18.2
      },
      {
        "question": "Question 2",
        "type": "Disagree",
        "value": 2,
        "percentage": 18.2,
        "percentage_start": -18.2,
        "percentage_end": 0
      },
      {
        "question": "Question 2",
        "type": "Neither agree nor disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": 0,
        "percentage_end": 0
      },
      {
        "question": "Question 2",
        "type": "Agree",
        "value": 7,
        "percentage": 63.6,
        "percentage_start": 0,
        "percentage_end": 63.6
      },
      {
        "question": "Question 2",
        "type": "Strongly agree",
        "value": 11,
        "percentage": 0,
        "percentage_start": 63.6,
        "percentage_end": 63.6
      },

      {
        "question": "Question 3",
        "type": "Strongly disagree",
        "value": 2,
        "percentage": 20,
        "percentage_start": -30,
        "percentage_end": -10
      },
      {
        "question": "Question 3",
        "type": "Disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": -10,
        "percentage_end": -10
      },
      {
        "question": "Question 3",
        "type": "Neither agree nor disagree",
        "value": 2,
        "percentage": 20,
        "percentage_start": -10,
        "percentage_end": 10
      },
      {
        "question": "Question 3",
        "type": "Agree",
        "value": 4,
        "percentage": 40,
        "percentage_start": 10,
        "percentage_end": 50
      },
      {
        "question": "Question 3",
        "type": "Strongly agree",
        "value": 2,
        "percentage": 20,
        "percentage_start": 50,
        "percentage_end": 70
      },

      {
        "question": "Question 4",
        "type": "Strongly disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": -15.6,
        "percentage_end": -15.6
      },
      {
        "question": "Question 4",
        "type": "Disagree",
        "value": 2,
        "percentage": 12.5,
        "percentage_start": -15.6,
        "percentage_end": -3.1
      },
      {
        "question": "Question 4",
        "type": "Neither agree nor disagree",
        "value": 1,
        "percentage": 6.3,
        "percentage_start": -3.1,
        "percentage_end": 3.1
      },
      {
        "question": "Question 4",
        "type": "Agree",
        "value": 7,
        "percentage": 43.8,
        "percentage_start": 3.1,
        "percentage_end": 46.9
      },
      {
        "question": "Question 4",
        "type": "Strongly agree",
        "value": 6,
        "percentage": 37.5,
        "percentage_start": 46.9,
        "percentage_end": 84.4
      },

      {
        "question": "Question 5",
        "type": "Strongly disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": -10.4,
        "percentage_end": -10.4
      },
      {
        "question": "Question 5",
        "type": "Disagree",
        "value": 1,
        "percentage": 4.2,
        "percentage_start": -10.4,
        "percentage_end": -6.3
      },
      {
        "question": "Question 5",
        "type": "Neither agree nor disagree",
        "value": 3,
        "percentage": 12.5,
        "percentage_start": -6.3,
        "percentage_end": 6.3
      },
      {
        "question": "Question 5",
        "type": "Agree",
        "value": 16,
        "percentage": 66.7,
        "percentage_start": 6.3,
        "percentage_end": 72.9
      },
      {
        "question": "Question 5",
        "type": "Strongly agree",
        "value": 4,
        "percentage": 16.7,
        "percentage_start": 72.9,
        "percentage_end": 89.6
      },

      {
        "question": "Question 6",
        "type": "Strongly disagree",
        "value": 1,
        "percentage": 6.3,
        "percentage_start": -18.8,
        "percentage_end": -12.5
      },
      {
        "question": "Question 6",
        "type": "Disagree",
        "value": 1,
        "percentage": 6.3,
        "percentage_start": -12.5,
        "percentage_end": -6.3
      },
      {
        "question": "Question 6",
        "type": "Neither agree nor disagree",
        "value": 2,
        "percentage": 12.5,
        "percentage_start": -6.3,
        "percentage_end": 6.3
      },
      {
        "question": "Question 6",
        "type": "Agree",
        "value": 9,
        "percentage": 56.3,
        "percentage_start": 6.3,
        "percentage_end": 62.5
      },
      {
        "question": "Question 6",
        "type": "Strongly agree",
        "value": 3,
        "percentage": 18.8,
        "percentage_start": 62.5,
        "percentage_end": 81.3
      },

      {
        "question": "Question 7",
        "type": "Strongly disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": -10,
        "percentage_end": -10
      },
      {
        "question": "Question 7",
        "type": "Disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": -10,
        "percentage_end": -10
      },
      {
        "question": "Question 7",
        "type": "Neither agree nor disagree",
        "value": 1,
        "percentage": 20,
        "percentage_start": -10,
        "percentage_end": 10
      },
      {
        "question": "Question 7",
        "type": "Agree",
        "value": 4,
        "percentage": 80,
        "percentage_start": 10,
        "percentage_end": 90
      },
      {
        "question": "Question 7",
        "type": "Strongly agree",
        "value": 0,
        "percentage": 0,
        "percentage_start": 90,
        "percentage_end": 90
      },

      {
        "question": "Question 8",
        "type": "Strongly disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": 0,
        "percentage_end": 0
      },
      {
        "question": "Question 8",
        "type": "Disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": 0,
        "percentage_end": 0
      },
      {
        "question": "Question 8",
        "type": "Neither agree nor disagree",
        "value": 0,
        "percentage": 0,
        "percentage_start": 0,
        "percentage_end": 0
      },
      {
        "question": "Question 8",
        "type": "Agree",
        "value": 0,
        "percentage": 0,
        "percentage_start": 0,
        "percentage_end": 0
      },
      {
        "question": "Question 8",
        "type": "Strongly agree",
        "value": 2,
        "percentage": 100,
        "percentage_start": 0,
        "percentage_end": 100
      }
    ]'
)

```

```{r}

color_scale = alt$Scale(
            domain=list("Strongly disagree",
            "Disagree",
            "Neither agree nor disagree",
            "Agree",
            "Strongly agree"),
            range= list("#c30d24", "#f3a583", "#cccccc", "#94c6da", "#1770ab")
        )

y_axis = alt$Axis(title='Question',
                  offset=5,
                  ticks=FALSE,
                  minExtent=60,
                  domain=FALSE)



plot <- alt$Chart(
  r_to_py(data)
)$mark_bar()$encode(
    x='percentage_start:Q',
    x2='percentage_end:Q',
    y=alt$Y('question:N', axis=y_axis),
    color=alt$Color(
        'type:N',
        legend=alt$Legend( title='Response'),
        scale=color_scale
    )
)

vegalite(plot)

```



#### Error Bars showing Confidence Interval

```{r}
points <- alt$Chart(
  r_to_py(vega_data$barley())
  )$mark_point(filled=TRUE)$encode(
    alt$X(
        'mean(yield)',
        scale=alt$Scale(zero=FALSE),
        axis=alt$Axis(title='Barley Yield')
    ),
    y='variety',
    color=alt$value('black')
)

error_bars = alt$Chart(
    r_to_py(vega_data$barley())
)$mark_rule()$encode(
    x='ci0(yield)',
    x2='ci1(yield)',
    y='variety'
)

vegalite(points + error_bars)

```

#### Gantt Chart

```{r}
dat <- jsonlite::fromJSON('[
    {"task": "A","start": 1, "end": 3},
    {"task": "B","start": 3, "end": 8},
    {"task": "C","start": 8, "end": 10}
  ]')

plot <- 
  alt$Chart(
    r_to_py(dat)
  )$mark_bar(
  )$encode(
    x = "start",
    x2 = "end",
    y = "task"
  )

vegalite(plot)

```

#### Grouped Bar Chart

```{r}
plot <- alt$Chart(
  r_to_py(vega_data$population())
  )$mark_bar(stroke='transparent')$encode(
    alt$X('gender:N', scale=alt$Scale(rangeStep=12), axis=alt$Axis(title='')),
    alt$Y('sum(people):Q', axis=alt$Axis(title='population', grid=FALSE)),
    color=alt$Color('gender:N', scale=alt$Scale(range=list("#EA98D2", "#659CCA"))),
    column='age:O'
)$configure_view(
    stroke='transparent'
)$configure_axis(
    domainWidth=0.8
)$transform_filter(
    "datum.year == 2000"
)$transform_calculate(
    'gender', "if_(datum.sex == 2, 'Female', 'Male')"
)

vegalite(plot)

```


#### Horizontal Aggregate Bar Chart

Need to specify the `transform_filter` as a string of JavaScript

```{r}

plot <- 
  alt$Chart(
    r_to_py(population)
  )$mark_bar(
  )$encode(
    x=alt$X('sum(people):Q', axis=alt$Axis(title='population')),
    y='age:O'
)$properties(
    height=300,
    width=300
)$transform_filter(
    JS('datum.year == 2000')
)

vegalite(plot)

```


#### Horizontal Stacked Bar Chart

```{r}
plot <- 
  alt$Chart(
    r_to_py(vega_data$barley())
  )$mark_bar(
  )$encode(
    x = "sum(yield)",
    y = "variety",
    color = "site"
  )

vegalite(plot)
```

#### LayerChart with Bar and Tick

```{r}
data = data_frame(
    project = c('a', 'b', 'c', 'd', 'e', 'f', 'g'),
    score = c(25, 57, 23, 19, 8, 47, 8),
    goal = c(25, 47, 30, 27, 38, 19, 4))


a = alt$Chart()$mark_bar()$encode(
    x='project',
    y='score'
)

b = alt$Chart()$mark_tick(
    color='red'
)$encode(
    x='project',
    y='goal'
)

plot <- alt$layer(a, b)$properties(
    data=r_to_py(data)
)$configure_tick(
    thickness=2,
    bandSize=35  # controls the width of the tick
)$configure_scale(
    rangeStep=40  # controls the width of the bar
)

vegalite(plot)
```

#### Layered Bar Chart

```{r}

source = r_to_py(vega_data$population())

plot <- alt$Chart(source)$mark_bar(opacity=0.7)$encode(
    alt$X('age:O', scale=alt$Scale(rangeStep=17)),
    alt$Y('sum(people):Q', axis=alt$Axis(title='population'), stack=NULL),
    alt$Color('gender:N', scale=alt$Scale(range=list("#EA98D2", "#659CCA")))
)$transform_filter(
    'datum.year == 2000'
)$transform_calculate(
    "gender", "if_(datum.sex == 2, 'Female', 'Male')"
)

vegalite(plot)
```

#### Layered Bar Chart with Line as Mean

```{r}

source = r_to_py(vega_data$seattle_weather())

bar = alt$Chart(source)$mark_bar()$encode(
    alt$X('date:O', timeUnit='month'),
    alt$Y('mean(precipitation):Q')
)

rule = alt$Chart(source)$mark_rule(color='red')$encode(
    y='mean(precipitation)',
    size=alt$value(3)
)

vegalite(bar + rule)
```

#### Layered Plot with Dual-Axis

```{r}
source = r_to_py(vega_data$seattle_weather())

base = alt$Chart(source)$encode(
    alt$X('date:O',
        axis=alt$Axis(format='%b'),
        timeUnit='month',
        scale=alt$Scale(zero=FALSE)
    )
)

bar = base$mark_bar()$encode(
    y='mean(precipitation)'
)


line =  base$mark_line(color='red')$encode(
    y='mean(temp_max)'
)

plot <- alt$layer(
    bar,
    line
)$resolve_scale(
    y='independent'
)

vegalite(plot)
```

#### Normalized Stacked Bar Chart

```{r}

source = r_to_py(vega_data$population())

plot <- alt$Chart(source)$mark_bar()$encode(
    alt$X('age:O', scale=alt$Scale(rangeStep=17)),
    alt$Y('sum(people):Q',
        axis=alt$Axis(title='population'),
        stack='normalize'
    ),
    alt$Color('gender:N',
        scale=alt$Scale(range=c("#EA98D2", "#659CCA"))
    )
)$transform_filter(
    'datum.year == 2000'
)$transform_calculate(
    "gender", "if_(datum.sex == 2, 'Female', 'Male')"
)

vegalite(plot)
```

#### Simple Bar Chart with Labels

```{r}

data = data_frame(
    a = c('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'),
    b = c(28, 55, 43, 91, 81, 53, 19, 87, 52))

bars = alt$Chart(r_to_py(data))$mark_bar()$encode(
    y='a',
    x='b'
)

text = bars$mark_text(
    align='left',
    baseline='middle',
    dx=3
)$encode(
    text='b'
)

vegalite(bars + text)
```

#### Stacked Bar Chart

```{r}
weather = r_to_py(vega_data$seattle_weather())

plot <- alt$Chart(weather)$mark_bar()$encode(
    alt$Color('weather:N',
        legend=alt$Legend(title='Weather type'),
        scale=alt$Scale(
            domain=list('sun', 'fog', 'drizzle', 'rain', 'snow'),
            range=list('#e7ba42', '#c7c7c7', '#aec7e8', '#1f77b4', '#9467bd')
        )
    ),
    alt$X('date:N',
        axis=alt$Axis(title='Month of the Year'),
        timeUnit='month'
    ),
    y='count(weather)'
)

vegalite(plot)
```

#### Trellis Stacked Bar Chart

```{r}

barley = r_to_py(vega_data$barley())

plot <- alt$Chart(barley)$mark_bar()$encode(
    column='year',
    x='sum(yield)',
    y='variety',
    color='site'
)$properties(
    width=250
)

vegalite(plot)
```












