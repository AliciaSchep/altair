---
title: "Interactive Charts"
author: "Haley Jeppson"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
```

Set-up:

```{r}
# devtools::install_github("ijlyttle/altair")
library("altair")

vega_data <- import_vega_data()
```



#### Faceted Scatter Plot with Linked Brushing

```{r}
brush <- alt$selection(type='interval', resolve='global')

base <- alt$Chart(
  r_to_py(vega_data$cars())
  )$mark_point()$encode(
    y='Miles_per_Gallon',
    color=alt$condition(brush, 'Origin', alt$ColorValue('gray'))
)$properties(
    selection=brush,
    width=250,
    height=250
)

vegalite(base$encode(x='Horsepower') | base$encode(x='Acceleration'))

```

#### Interactive Average

```{r}
weather <- r_to_py(vega_data$seattle_weather())
brush <- alt$selection(type='interval', encodings=list('x'))

bars <- alt$Chart()$mark_bar()$encode(
    alt$X('date:O', timeUnit='month'),
    y='mean(precipitation):Q',
    opacity=alt$condition(brush, alt$OpacityValue(1), alt$OpacityValue(0.7))
)$properties(
    selection=brush
)

line <- alt$Chart()$mark_rule(color='firebrick')$encode(
    y='mean(precipitation):Q',
    size=alt$SizeValue(3)
)$transform_filter(brush$ref())

vegalite(alt$layer(bars, line, data=weather))

```

#### Interactive Chart with Cross-Highlight



```{r, eval = FALSE}
pts = alt$selection(type = "single", encodings= list('x'))

rect = alt$Chart(
  r_to_py(vega_data$movies())
  )$mark_rect(
  )$encode(
    alt$X('IMDB_Rating:Q', bin=TRUE),
    alt$Y('Rotten_Tomatoes_Rating:Q', bin=TRUE),
    alt$Color('count(IMDB_Rating)',
        scale=alt$Scale(scheme='greenblue'),
        legend=alt$Legend(title='Total Records')
    )
)


circ <- 
  rect$mark_point(
  )$encode(
    alt$ColorValue('grey'),
    alt$Size('count(IMDB_Rating)',
        legend=alt$Legend(title='Records in Selection')
    )
)$transform_filter(
    pts$ref()
)

bar = alt$Chart(
  r_to_py(vega_data$movies())
)$mark_bar(
)$encode(
    x='Major_Genre:N',
    y='count(Major_Genre)',
    color=alt$condition(pts, alt$ColorValue("steelblue"), alt$ColorValue("grey"))
)$properties(
    selection=pts,
    width=550,
    height=200
)

plot <- alt$vconcat(
     alt$LayerChart(layer = list(rect, circ)),
    bar
)$resolve_legend(
    color="independent",
    size="independent"
)

vegalite(plot)


```

#### Interactive Crossfilter (has issue)

not sure what to do with the date variable

Note: `alt$repeat` must be defined as alt$`repeat`

```{r, eval = FALSE}
flights = vega_data$flights_2k()
flights$date <- as.character(flights$date))

brush = alt$selection_interval()

# Define the base chart, with the common parts of the
# background and highlights
base = alt$Chart()$mark_bar()$encode(
    x=alt$X(alt$`repeat`('column'), type='quantitative', bin=alt$Bin(maxbins=20)),
    y='count(delay)'
)$properties(
    width=180,
    height=130
)

# blue background with selection
background = base$properties(
    selection=brush
)

# yellow highlights on the transformed data
highlight = base$encode(
    color=alt$value('goldenrod')
)$transform_filter(
    brush$ref()
)

# layer the two charts & repeat
plot <- alt$layer(
    background, highlight,
    data=r_to_py(flights)
)$transform_calculate(
    "time", "hours(datum.date)"
)$`repeat`(
    column= list("distance", "delay", "time")
)

vegalite(plot)

```

#### Interactive Rectangular Brush

```{r}
brush = alt$selection(type='interval')

plot <- 
  alt$Chart(
    r_to_py(vega_data$cars())
  )$mark_point(
  )$encode(
    x='Horsepower:Q',
    y='Miles_per_Gallon:Q',
    color=alt$condition(brush, 'Cylinders:O', alt$value('grey'))
)$properties(
    selection=brush
)

vegalite(plot)
```

#### Multi-Line Highlight

```{r}

highlight = alt$selection_single(on='mouseover',
                          fields=list('symbol'), nearest=TRUE)

base = alt$Chart(r_to_py(vega_data$stocks()))$encode(
    x='date:T',
    y='price:Q',
    color='symbol:N'
)

points = base$mark_circle()$encode(
    opacity=alt$value(0)
)$properties(
    selection=highlight,
    width=600
)

lines = base$mark_line()$encode(
    size=alt$condition(highlight$`__invert__`(), alt$value(1), alt$value(3))
)

vegalite(points + lines)

```


#### Multi-Line Tooltip


#### Seattle Weather Interactive

```{r, eval = FALSE}
scale = alt$Scale(domain= list('sun', 'fog', 'drizzle', 'rain', 'snow'),
                  range=list('#e7ba52', '#a7a7a7', '#aec7e8', '#1f77b4', '#9467bd'))
color = alt$Color('weather:N', scale=scale)

# We create two selections:
# - a brush that is active on the top panel
# - a multi-click that is active on the bottom panel
brush = alt$selection_interval(encodings=list('x'))
click = alt$selection_multi(encodings= list('color'))

# Top panel is scatter plot of temperature vs time
points = alt$Chart()$mark_point()$encode(
    alt$X('date:T', timeUnit='monthdate', axis=alt$Axis(title='Date')),
    alt$Y('temp_max:Q',
        axis=alt$Axis(title='Maximum Daily Temperature (C)'),
        scale=alt$Scale(domain=list(-5, 40))
    ),
    color=alt$condition(brush, color, alt$value('lightgray')),
    size=alt$Size('precipitation:Q', scale=alt$Scale(range=list(5, 200)))
)$properties(
    width=600,
    height=300,
    selection=brush
)$transform_filter(
    click$ref()
)

# Bottom panel is a bar chart of weather type
bars = alt$Chart()$mark_bar()$encode(
    x='count(weather)',
    y='weather:N',
    color=alt$condition(click, color, alt$value('lightgray'))
)$transform_filter(
    brush$ref()
)$properties(
    width=600,
    selection=click
)

vegalite(alt$vconcat(points, bars,
    data=r_to_py(vega_data$seattle_weather()),
    title="Seattle Weather: 2012-2015"
))
```

#### Selection Detail Example


#### Selection Histogram

```{r}
cars = r_to_py(vega_data$cars())

brush = alt$selection(type='interval')

points = alt$Chart()$mark_point()$encode(
    x='Horsepower:Q',
    y='Miles_per_Gallon:Q',
    color=alt$condition(brush, 'Origin:N', alt$value('lightgray'))
)$properties(
    selection=brush
)

bars = alt$Chart()$mark_bar()$encode(
    y='Origin:N',
    color='Origin:N',
    x='count(Origin):Q'
)$transform_filter(
    brush$ref()
)

vegalite(alt$vconcat(points, bars, data=cars))
```

#### Simple Interactive Colored Scatterplot

```{r}
plot <-alt$Chart(
  r_to_py(vega_data$cars())
)$mark_circle()$encode(
    x='Horsepower',
    y='Miles_per_Gallon',
    color='Origin'
)$interactive()

vegalite(plot)
```

#### US Population Over Time

```{r}
pop = r_to_py(vega_data$population())

pink_blue = alt$Scale(domain=list('Male', 'Female'),
                      range=list("steelblue", "salmon"))

slider = alt$binding_range(min=1900, max=2000, step=10)
year = alt$selection_single(name="year", fields=list('year'), bind=slider)

plot <- alt$Chart(pop)$mark_bar()$encode(
    x=alt$X('sex:N', axis=alt$Axis(title=NULL)),
    y=alt$Y('people:Q', scale=alt$Scale(domain=c(0, 12000000))),
    color=alt$Color('sex:N', scale=pink_blue),
    column='age:O'
)$properties(
    width=20,
    selection=year
)$transform_calculate(
    "sex", 'if_(datum.sex == 1, "Male", "Female")'
)$transform_filter(
    year$ref()
)

vegalite(plot)
```






