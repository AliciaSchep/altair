---
title: "Interactive Charts"
author: "Haley Jeppson"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
editor_options: 
  chunk_output_type: inline
---

This document is adapted from the [Bar Charts](https://altair-viz.github.io/gallery/index.html#bar-charts) section of the Altair Example Gallery.

Our first step is to set up our environment:

```{r}
# devtools::install_github("vegawidget/altair")
library("altair")
library("tibble")

vega_data <- import_vega_data()
```

## Faceted Scatter Plot with Linked Brushing

[Altair example](https://altair-viz.github.io/gallery/scatter_linked_brush.html)

#### Data

```{r}
glimpse(vega_data$cars())
```

#### Chart

```{r}
brush <- alt$selection(type = "interval", resolve="global")

base <- 
  alt$Chart(r_to_py(vega_data$cars()))$
  mark_point()$
  encode(
    y="Miles_per_Gallon",
    color=alt$condition(brush, "Origin", alt$ColorValue("gray"))
  )$
  properties(selection = brush, width = 250, height=250)

chart <- (base$encode(x = "Horsepower") | base$encode( x = "Acceleration"))

chart
```

## Interactive Average

[Altair example](https://altair-viz.github.io/gallery/selection_layer_bar_month.html)

#### Data

```{r}
weather <- vega_data$seattle_weather()

glimpse(weather)
```

#### Chart

```{r}
weather <- r_to_py(weather)
brush <- alt$selection(type = "interval", encodings = list("x"))

bars <- 
  alt$Chart()$
  mark_bar()$
  encode(
    x = alt$X("date:O", timeUnit="month"),
    y = "mean(precipitation):Q",
    opacity = alt$condition(brush, alt$OpacityValue(1), alt$OpacityValue(0.7))
  )$
  properties(selection = brush)

line <- 
  alt$Chart()$
  mark_rule(color="firebrick")$
  encode(
    y = "mean(precipitation):Q",
    size = alt$SizeValue(3)
  )$
  transform_filter(brush$ref())

chart <- alt$layer(bars, line, data=weather)

chart
```

## Interactive Chart with Cross-Highlight

[Altair example](https://altair-viz.github.io/gallery/interactive_cross_highlight.html)

#### Data

```{r}
movies <- vega_data$movies()
glimpse(movies)
```

#### Chart

```{r, eval = FALSE}
pts <- alt$selection(type = "single", encodings = list("x"))

rect <- 
  alt$Chart(r_to_py(movies))$
  mark_rect()$
  encode(
    x = alt$X("IMDB_Rating:Q", bin = TRUE),
    y = alt$Y("Rotten_Tomatoes_Rating:Q", bin=TRUE),
    color = alt$Color(
      "count(IMDB_Rating)",
      scale = alt$Scale(scheme = "greenblue"),
      legend = alt$Legend(title = "Total Records")
    )
  )

circ <- 
  rect$
  mark_point()$
  encode(
    color = alt$ColorValue("grey"),
    size = alt$Size(
      "count(IMDB_Rating)",
      legend = alt$Legend(title = "Records in Selection")
    )
  )$
  transform_filter(pts$ref())

bar <- 
  alt$Chart(r_to_py(movies))$
  mark_bar()$
  encode(
    x = "Major_Genre:N",
    y = "count(Major_Genre)",
    color = alt$condition(pts, alt$ColorValue("steelblue"), alt$ColorValue("grey"))
  )$
  properties(selection = pts, width = 550, height = 200)

chart <- 
  ((rect + circ) & bar)$ 
  resolve_legend(color = "independent", size = "independent")
  
chart
```

## Interactive Crossfilter

[Altair example](https://altair-viz.github.io/gallery/interactive_layered_crossfilter.html)

Note: `alt$repeat()` must be translated to  `alt$\x60repeat\x60()`.

#### Data

```{r}
flights <- vega_data$flights_2k()
glimpse(flights)
```

#### Chart

```{r, eval = FALSE}
brush <- alt$selection_interval(encodings = list("x"))

# Define the base chart, with the common parts of the
# background and highlights
base <- 
  alt$Chart()$
  mark_bar()$
  encode(
    x = alt$X(
      alt$`repeat`("column"), 
      type = "quantitative", 
      bin = alt$Bin(maxbins=20)
    ),
    y = "count(delay)"
  )$
  properties(width = 180, height = 130)

# blue background with selection
background <- base$properties(selection = brush)

# yellow highlights on the transformed data
highlight <- 
  base$
  encode(
    color = alt$value("goldenrod")
  )$
  transform_filter(brush$ref())

# layer the two charts & repeat
chart <- 
  (background + highlight)$ 
  properties(data = r_to_py(flights))$
  transform_calculate("time", "hours(datum.date)")$
  `repeat`(column = list("distance", "delay", "time"))

chart
```

## Interactive Rectangular Brush

[Altair example](https://altair-viz.github.io/gallery/interactive_brush.html)

#### Data

```{r}
glimpse(vega_data$cars())
```

#### Chart

```{r}
brush <- alt$selection(type = "interval")

chart <- 
  alt$Chart(r_to_py(vega_data$cars()))$
  mark_point()$
  encode(
    x = "Horsepower:Q",
    y = "Miles_per_Gallon:Q",
    color = alt$condition(brush, "Cylinders:O", alt$value("grey"))
  )$
  properties(selection = brush)

chart
```

## Multi-Line Highlight


[Altair example](https://altair-viz.github.io/gallery/multiline_highlight.html)

#### Data

```{r}
glimpse(vega_data$stocks())
```

#### Chart

```{r}
highlight <- 
  alt$selection_single(
    on = "mouseover",
    fields = list("symbol"), 
    nearest = TRUE
  )

base <- 
  alt$Chart(r_to_py(vega_data$stocks()))$
  encode(
    x = "date:T",
    y = "price:Q",
    color = "symbol:N"
  )

points <- 
  base$mark_circle()$
  encode(
    opacity = alt$value(0)
  )$
  properties(selection = highlight, width = 600)

lines <- 
  base$
  mark_line()$
  encode(
    size = alt$condition(highlight, alt$value(3), alt$value(1))
  )

chart <- (points + lines)

chart
```

## Multi-Line Tooltip


[Altair example]()


#### Seattle Weather Interactive

```{r, eval = FALSE}
scale <- alt$Scale(
  domain = list("sun", "fog", "drizzle", "rain", "snow"),
  range = list("#e7ba52", "#a7a7a7", "#aec7e8", "#1f77b4", "#9467bd")
)

color <- alt$Color("weather:N", scale = scale)

# We create two selections:
# - a brush that is active on the top panel
# - a multi-click that is active on the bottom panel
brush <- alt$selection_interval(encodings = list("x"))
click <- alt$selection_multi(encodings = list("color"))

# Top panel is scatter plot of temperature vs time
points <- 
  alt$Chart()$
  mark_point()$
  encode(
    x = alt$X(
      "date:T", 
      timeUnit = "monthdate", 
      axis=alt$Axis(title="Date")
    ),
    alt$Y(
      "temp_max:Q",
      axis = alt$Axis(title = "Maximum Daily Temperature (C)"),
      scale = alt$Scale(domain = list(-5, 40))
    ),
    color = alt$condition(brush, color, alt$value("lightgray")),
    size = alt$Size("precipitation:Q", scale = alt$Scale(range = list(5, 200)))
  )$
  properties(width = 600, height = 300, selection = brush)$
  transform_filter(click$ref())

# Bottom panel is a bar chart of weather type
bars <- 
  alt$Chart()$
  mark_bar()$
  encode(
    x = "count(weather)",
    y = "weather:N",
    color = alt$condition(click, color, alt$value("lightgray"))
  )$
  transform_filter(brush$ref())$
  properties(width = 600, selection = click)

chart <- 
  (points & bars)$ 
  properties(
    data = r_to_py(vega_data$seattle_weather()),
    title = "Seattle Weather: 2012-2015"
  )  
```

## Selection Detail Example


[Altair example]()

## Selection Histogram


[Altair example]()


#### Data

```{r}
glimpse(vega_data$cars())
```

#### Chart

```{r}
cars <- r_to_py(vega_data$cars())

brush <- alt$selection(type="interval")

points <- 
  alt$Chart()$
  mark_point()$
  encode(
    x = "Horsepower:Q",
    y = "Miles_per_Gallon:Q",
    color = alt$condition(brush, "Origin:N", alt$value("lightgray"))
  )$
  properties(selection = brush)

bars <- 
  alt$Chart()$
  mark_bar()$
  encode(
    x = "count(Origin):Q",
    y = "Origin:N",
    color = "Origin:N"
  )$
  transform_filter(brush$ref())

chart <- alt$vconcat(points, bars, data = cars)

chart
```

## Simple Interactive Colored Scatterplot


[Altair example]()

#### Data

```{r}
glimpse(vega_data$cars())
```

#### Chart

```{r}
chart <- 
  alt$Chart(r_to_py(vega_data$cars()))$
  mark_circle()$
  encode(
    x = "Horsepower",
    y = "Miles_per_Gallon",
    color = "Origin"
  )$
  interactive()

vegalite(plot)
```

## US Population Over Time


[Altair example]()

#### Data

```{r}
glimpse(vega_data$population())
```

#### Chart

```{r}
pop <- r_to_py(vega_data$population())

pink_blue <- 
  alt$Scale(
    domain = list("Male", "Female"),
    range = list("steelblue", "salmon")
  )

slider <- alt$binding_range(min = 1900, max = 2000, step = 10)

year <- alt$selection_single(
  name = "year", 
  fields = list("year"), 
  bind = slider
)

chart <- 
  alt$Chart(pop)$
  mark_bar()$
  encode(
    x = alt$X("sex:N", axis = alt$Axis(title = NULL)),
    y = alt$Y("people:Q", scale = alt$Scale(domain = c(0, 1.2e7))),
    color = alt$Color("sex:N", scale = pink_blue),
    column = "age:O"
  )$
  properties(width = 20, selection = year)$
  transform_calculate("sex", 'if_(datum.sex == 1, "Male", "Female")')$
  transform_filter(year$ref())

chart
```






